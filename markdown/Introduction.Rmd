---
title: "Analyzing Baseball Data with R - Introduction to R"
author: "Tomoka Takegaki"
date: "23/11/2021"
output: pdf_document
---

This project is to learn analyze baseball data with R. The source is from a book "Analyzing Baseball Data with R". This is a section of "Introduction to R".

```{r}
#install.packages("Lahman")
library(tidyverse)
library(dplyr)
library(Lahman)

setwd("C:/Users/ttake/Documents/My_Data_Analysis_Projects/Analyzing_Baseball_Data_R//")
```

```{r}
# Create a data frame for Babe Ruth
bruth_pitch_df <- Pitching[Pitching$playerID=="ruthba01",]

# Aggregate ERA data
bruth_pitch_df %>% 
    summarize(
        LO = min(ERA),
        QL = quantile(ERA,.25), QU = quantile(ERA,.75),M = median(ERA),
        Hi = max(ERA)
    )

# Year of the lowerst ERA of Babe Ruth
bruth_pitch_df %>% filter(ERA==min(ERA)) %>% select(yearID)

# Adding new column "FIP", Fielding independent pitching.
bruth_pitch_df <- bruth_pitch_df %>% 
    mutate(FIP = (13 * HR + 3 * BB -2 * SO)/IPouts) 

# Sort the data by FIP(ascending)
bruth_pitch_df %>% 
    arrange(FIP) %>% 
    select(yearID,W,L,ERA,FIP) %>% 
    head(10)

# Performance for each team Babe ruth played.
bruth_pitch_df %>% 
    group_by(teamID) %>% 
    summarize(mean_W = mean(W),
              mean_L = mean(L),
              mean_ERA = mean(ERA),
              mean_FIP = mean(FIP))
```


```{r}
# Vector
Win.Pct <- 100 * bruth_pitch_df$W / (bruth_pitch_df$W + bruth_pitch_df$L)

Age <- bruth_pitch_df$yearID - 1895
plot(Age,Win.Pct)
summary(Win.Pct)
```

```{r}
# Character data and data frame
Year <- 2008:2017
NL <- c("PHI","PHI","SFN","SLN","SFN",
        "SLN","SFN","NYN","CHN","LAN")
AL <- c("TBA","NYA","TEX","TEX","DET",
        "BOS","KCA","KCA","CLE","HOU")
Winner <- c("NL","AL","NL","NL","NL",
            "AL","NL","AL","NL","AL")
N_Games <- c(5,6,5,7,4,7,7,5,7,7)

# Create a data frame
WS_results <- tibble(
    Year = Year, NL_Team =  NL, AL_Team = AL,
    N_Games = N_Games, Winner = Winner)

# Find patterns
grep("NY",c(AL,NL),value=TRUE)

WS <- WS_results %>% 
    group_by(Winner) %>% 
    summarize(N=n())
WS

# plot bar chart
ggplot(WS,mapping = aes(x=Winner,y=N)) +
    geom_col()
```

```{r}
# Factors
WS_results %>% 
    group_by(NL_Team) %>% 
    summarize(N=n())

WS_results <- WS_results %>% 
    mutate(NL_Team = factor(NL_Team, levels = c("NYN","PHI","CHN",
                                                "SLN","LAN","SFN")))
str(WS_results$NL_Team)
WS_results %>% 
    group_by(NL_Team) %>% 
    summarize(N=n())
```

```{r}
# Lists
world_series <- list(Winner=Winner, Number.Games=N_Games, Seasons="2008 to 2017")
world_series
```

```{r}
# Frequency of number of games (less than 8) in 1903.
ws <- filter(SeriesPost, yearID >= 1903,
       round == "WS", wins+losses < 8)

ggplot(ws,mapping = aes(x=wins+losses)) + 
    geom_bar(fill="blue") +
    labs(x="Number of games", y="Frequency")
```

```{r}
# Calculate Home run rate (Micky mantle)
hr_rates <- function(age,hr,ab){
    rates <- round(100 * hr / ab, 1)
    list(x=age, y=rates)
}

HR <- c(13,23,21,27,37,52,34,42,31,40,54)
AB <- c(341,549,461,543,517,533,474,519,541,527,514)
Age <- c(19:29)

# Scatter plot
plot(hr_rates(Age,HR,AB))
hr_rates <- hr_rates(Age,HR,AB)

# Writing csv file
Mantle <- data.frame(Age, HR,AB,Rates=hr_rates$y)
write.csv(Mantle,"csv_files/mantle.csv")
```

```{r}
# Splitting, Applying, and Combining data

# Batting data between 1960 and 1969.
Batting %>% 
    filter(yearID>=1960, yearID <=1969) -> Batting_60

# Total number of homeruns for each player
Batting_60 %>% 
    group_by(playerID) %>% 
    summarize(Total_HR = sum(HR)) -> hr_60


# Sort the hr_60 data in desc order
hr_60 %>% 
    arrange(desc(Total_HR))->hr_60

head(hr_60)

```

```{r}
# Iterating using map()
hr_leader <- function(data){
    data %>% 
        group_by(playerID) %>% 
        summarize(Total_HR = sum(HR)) %>% 
        arrange(desc(Total_HR)) %>% 
        head(1)
}

# Home run leader for each decade.
Batting %>% 
    mutate(decade = 10 * floor(yearID/10)) %>% 
    split(pull(.,decade)) %>% 
    map_df(hr_leader, .id="decade") -> hr_by_decade

hr_by_decade
```

```{r}
# Collect the career batting statistics
Batting %>% 
    group_by(playerID) %>% 
    summarize(tAB = sum(AB,na.rm = TRUE),
              tHR = sum(HR,na.rm = TRUE), 
              tSO = sum(SO,na.rm = TRUE)) -> long_careers

# filter tAB >= 5000 players 
Batting_5000 <- filter(long_careers, tAB >= 5000)
head(Batting_5000)

# Correlation between HR rates & SO rates
ggplot(Batting_5000, mapping = aes(x=tHR/tAB, y=tSO/tAB))+ 
    geom_point() + geom_smooth()
```
We can see clearly that batters with higher home run rates tend to have higher strikeout rates.

# Exercises

## 1. Top Base Stealers in the Hall of Fame
```{r}
# (a) Create a data frame
players <- c("Rickey Henderson","Lou Brock","Ty Cobb","Eddie Collins","Max Carey","Joe Morgan","Luis Aparico","Paul Molitor","Roberto Alomar")
SB <- c(1406,938,897,741,738,689,506,504,474)
CS <- c(335,307,212,195,109,162,136,131,114)
G <- c(3081,2616,3034,2826,2476,2649,2599,2683,2379)
sb_df <- data.frame(players,SB,CS,G)
sb_df

# (b) Create New column "SB.Attempt" (SB+CS)
sb_df <- sb_df %>% 
    mutate(SB.Attempt = SB + CS)

# (c) Create New column "SB.Game" (SB/G) Stolen bases per game
sb_df <- sb_df %>% 
    mutate(SB.Game = SB / G)

sb_df <- sb_df %>% 
    mutate(SB.SuccessRate = 100 * SB / SB.Attempt)

sb_df

#install.packages("ggrepel")
library(ggrepel)

ggplot(sb_df, mapping = aes(x=SB.Game,y=SB.SuccessRate))+
    geom_point() + geom_label_repel(aes(label = players), size = 3)
```

1. Are there are particular players with unusually high or low stolen base success rates?
- Max Carey had the highest stolen base success rate with 87.1%.
- Lou Brock had the lowest stolen base success rate with 75.3%.  
     

2. Which player had the greatest number of stolen bases per game?
- Rickey Henderson had the greatest number of stolen bases per game : 0.46 / game.


## 2. Character, Factor, and Logical Variables in R

Suppose one records the outcomes of a batter in ten plate appearance. 

```{r}
outcomes <- c("Single","Out","Out","Single","Out","Double","Out","Walk","Out","Single")

# (a) Construct a frequency table
table(outcomes)

# (b) Ordered from least_successful to most-successful
f.outcomes <- factor(outcomes,levels = c("Out","Walk","Single","Double"))
table(f.outcomes)

```
table a and b appeared in different order. 
Factor enables us to reorder the table.


(d) Suppose you only want to focus on the walks in the plate appearances. Describe what is done in each of the following statements.
```{r}
outcomes == "Walk"
sum(outcomes == "Walk")
```
In the first line, it checks the all the value in the outcome vector if the value is equal to "Walk". It returns True or False. 
In the second line, it counts how many "Walk" is in the outcome vector. In this case, it returns 1.


# 3. Pitches in the 350-Wins Club
```{r}
#(a) Create vectors
p_players <- c("Pete Alexander","Roger Clements","Pud Galvin","Walter Johnson","Greg Maddux","Christy Mathewson","Kid Nichols","Warren Spahn","Cy Young")
W <- c(373,354,364,417,355,373,361,363,511)
L <- c(208,184,310,279,227,188,208,245,316)
SO <- c(2198,4672,1806,3509,3371,2502,1868,2583,2803)
BB <- c(951,1580,745,1363,999,844,1268,1434,1217)
# (b) Calculate Winning percentage
Win.PCT = (100 * W/W+L)

# (c) Create a data frame
Wins.350 <- data.frame(p_players,W,L,Win.PCT)

# (d) Sort the data by Win.PCT 
Wins.350 <- Wins.350 %>% arrange(Win.PCT)
Wins.350
```
1. Who had the largest winning percentage?
- Roger Clements
    
2. Who had the smallest winning percentage?
- Cy Young
    

# 4. Pitchers in the 350-Wins Club, Continued
```{r}
# (b)Create a vecor strikeout-walk ratio
SO.BB.Ratio <- SO/BB

# (c)Create a data frame
SO.BB <- data.frame(p_players,SO,BB,SO.BB.Ratio)

# (d) filter the data who had strikeout-ratio more than 2.8.
SO.BB<- SO.BB %>% filter(SO.BB.Ratio > 2.8)

# (e) Sort by Walk
SO.BB <- SO.BB %>% arrange(desc(BB))

SO.BB     
```

1. Did the pitcher with the highest walks have a high or low strikeout-walk ratio?
- 
